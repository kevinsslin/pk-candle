import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';
import type { PlayerSummary, SessionStatus } from '@pk-candle/shared';

export type Language = 'en' | 'zh-CN';

const STORAGE_KEY = 'pkcandle-lang';

const MESSAGES = {
  en: {
    appName: 'PK Candle',
    turboRoom: 'Turbo Room',
    lobby: 'Lobby',
    leaderboard: 'Leaderboard',
    leaveRoom: 'Leave Room',
    signedIn: 'Signed in',
    guest: 'Guest',
    loading: 'Loading',
    login: 'Login',
    logout: 'Logout',
    languageLabel: 'Lang',
    languageToggle: 'Switch language',
    languageFlagsTitle: 'Language',
    languageChinese: 'ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰',
    languageEnglish: 'English',
    joiningRoom: 'Checking room access...',

    missingWsTitle: 'Missing WebSocket URL',
    missingWsBody: 'Set VITE_WS_URL to connect to the server.',

    roomNotFoundTitle: 'Room not found',
    roomNotFoundBody: 'Pick a room from the lobby.',
    alreadyInRoomTitle: 'You are already in {roomId}',
    alreadyInRoomBody: 'Leave the current room before joining another.',
    goToRoom: 'Go to Room',
    backToLobby: 'Back to Lobby',
    joinRoomTitle: 'Join Room {roomId}',
    enterRoomKey: 'Enter the room key if it is locked.',
    nameLabel: 'Name',
    roomKeyLabel: 'Room Key',
    roomKeyPlaceholder: 'room key',
    roomLockLabel: 'Room Lock',
    roomLockOn: 'Locked',
    roomLockOff: 'Unlocked',
    roomLockHint: 'Require a key to join this room.',
    roomNameLabel: 'Room Name (max 24, emoji ok)',
    roomNamePlaceholder: 'Kevinâ€™s Dinner Table ğŸ¤“',
    maxPlayersLabel: 'Max Players (2-6)',
    playersCount: '{count} players',
    enterRoom: 'Enter Room',
    connecting: 'Connecting...',

    sessionTitle: 'Session',
    statusLabel: 'Status',
    roundLabel: 'Round {round}/{total}',
    timeLeftLabel: 'Time left {time}',
    startingIn: 'Starting in {seconds}s',
    getReady: 'Get ready',
    paused: 'Paused',
    eventPausedTitle: 'Global event pause',
    eventPausedBody: 'Market event resolved. Trading resumes after the countdown.',
    eventImpactTitle: 'Impact',
    eventImpactPhase: 'Phase: {phase}',
    eventImpactVolatility: 'Volatility: {value}',
    eventImpactPrice: 'Price multiplier: x{value}',
    eventImpactNeutral: 'No direct market impact.',
    nextRoundIn: 'Next round in {seconds}s',
    personalEventCountdown: 'Auto-resolve in {seconds}s',
    personalEventExpired: 'Event expired. Resolving...',
    respawnWarning: 'System Alert',
    respawnTitleBroke: 'Liquidated',
    respawnTitleDead: 'Knocked Out',
    respawnPenalty: 'Penalty: reset to {percent}% of base cash.',
    respawnCurrentCash: 'Current cash: {cash} U',
    respawnNewCash: 'New cash: {cash} U',
    respawnCountdown: 'Respawn in {seconds}s',

    you: 'You',
    cash: 'Cash',
    equity: 'Equity',
    pnl: 'PnL',
    stress: 'Stress',
    connection: 'Connection',
    connectionIdle: 'Idle',
    connectionConnecting: 'Connecting',
    connectionConnected: 'Connected',
    connectionError: 'Error',

    globalEvents: 'Global Events',
    noMarketShocks: 'No market shocks yet.',

    marketTitle: 'Market',
    loadingToken: 'Loading token...',
    phaseLabel: 'Phase: {phase}',
    goLive: 'Go Live',
    fitView: 'Fit View',
    localTime: 'Local time: {time}',
    lastCandle: 'Last candle: {time}',
    scrollToZoom: 'Scroll to zoom',
    timeframe1s: '1s',
    timeframe5s: '5s',
    timeframe10s: '10s',

    tradeTitle: 'Trade',
    tradingDisabledTitle: 'Trading disabled',
    tradingDisabledGeneric: 'You cannot trade right now.',
    orderSize: 'Order Size',
    percent: 'Percent',
    amount: 'Amount',
    available: 'Available',
    orderValue: 'Order value',
    size: 'Size',
    positionMargin: 'Position margin',
    addOrderValue: 'Add value',
    reduceOrderValue: 'Reduce value',
    tpPlaceholder: 'TP %',
    slPlaceholder: 'SL %',
    tpSlTitle: 'Optional TP/SL',
    tpSlHint: 'Auto-close when price hits your target.',
    leverage: 'Leverage',
    long: 'Long',
    short: 'Short',
    openLong: 'Open Long',
    openShort: 'Open Short',
    addLong: 'Add Long',
    addShort: 'Add Short',
    reduceLong: 'Reduce Long',
    reduceShort: 'Reduce Short',
    closePosition: 'Close Position',
    positionTitle: 'Position',
    noOpenPosition: 'No open position.',
    side: 'Side',
    entry: 'Entry',
    price: 'Price',
    liquidation: 'Liquidation',
    entryLine: 'Entry',
    avgCostLine: 'Avg Cost',
    markPriceLine: 'Mark Price',
    liquidationLine: 'Liq',
    margin: 'Margin',
    tradeHistory: 'Recent Trades',
    tradeOpen: 'Open',
    tradeClose: 'Close',
    tradeLiquidation: 'Liquidation',
    noTradesYet: 'No trades yet.',

    chat: 'Chat',
    chatRoom: 'Chat Room',
    chatPlaceholder: 'Type a message',
    chatJoinPlaceholder: 'Join the room to chat',
    send: 'Send',
    danmakuOn: 'On',
    danmakuOff: 'Off',
    danmakuLabel: 'Danmaku',
    close: 'Close',
    spectatorTag: 'SPEC',

    roomRank: 'Room Rank',
    topN: 'Top {count}',
    roomPnl: 'Room PnL',
    noPlayersYet: 'No players yet.',
    packLabel: 'Pack',
    corePack: 'Core',
    hostLabel: 'Host',
    packHelp: 'Event pack = room rules + events.',
    packTitle: 'Event Pack',
    packSelectLabel: 'Select pack',
    packVersion: 'v{version}',
    packNoDescription: 'No description yet.',
    packPersonalCount: '{count} Personal',
    packMarketCount: '{count} Market',
    createPack: 'Create Pack',
    editPack: 'Edit Pack',
    deletePack: 'Delete Pack',
    packLockedNote: 'Pack changes are locked after countdown.',

    lobbyTitle: 'Lobby',
    roomLabel: 'Room: {roomId}',
    inviteCrew: 'Invite Crew',
    inviteCopied: 'Invite Copied',
    inviteFailed: 'Copy Failed',
    inviteTitle: 'PK Candle raid is live.',
    inviteRoomCode: 'Room code: {roomId}',
    inviteBringTrades: 'Bring your best trades.',
    inviteLockedNote: 'Room is locked. Ask host for the key.',
    inviteUnlockedNote: 'No key required.',
    inviteJoin: 'Join: {url}',
    inviteCopyPrompt: 'Copy this invite',
    readyCount: 'Ready {ready}/{total}',
    cancelReady: 'Cancel Ready',
    readyUp: 'Ready Up',
    startCountdown: 'Start Countdown',
    waitingHost: 'Waiting for host',
    readyUpToStart: 'Ready up to start',
    roomLockTitle: 'Room Lock',
    locked: 'Locked',
    unlocked: 'Unlocked',
    hostControlsKey: 'Host controls the room key.',
    setUpdateKey: 'Set / Update Key',
    setRoomKeyPlaceholder: 'set room key',
    setNewRoomKeyPlaceholder: 'set a new room key',
    updateKey: 'Update Key',
    removeLock: 'Remove Lock',
    lockHelp: 'Players enter the key after entering the room.',
    lockDisabled: 'Lock changes are disabled once the countdown starts.',
    seatsTitle: 'Seats (max {max})',
    seatLabel: 'Seat {number}',
    ready: 'Ready',
    notReady: 'Not ready',
    online: 'Online',
    offline: 'Offline',
    kick: 'Kick',
    emptySeat: 'Empty seat',
    spectatorsTitle: 'Spectators',
    spectatorDisabled: 'Spectator mode is disabled for now.',
    hostTag: 'HOST',

    startTitle: 'PK Candle',
    startTagline: 'Meme-market PvP. Ride the same candle, survive the chaos, and flex your gains.',
    startBadgeLive: 'Live Rooms',
    startBadgeLobbies: '6-Player Lobbies',
    startBadgeLeaderboard: 'Global Leaderboard',

    createRoomTitle: 'Create Room',
    createRoomBody: 'Spin up a lobby, then share the invite from inside the room.',
    playerNameLabel: 'Player Name',
    playerNamePlaceholder: 'Turbo Trader',
    roomCodeLabel: 'Room Code',
    roomCodeAutoPlaceholder: 'auto code',
    newCode: 'New Code',
    roomNameLabelShort: 'Room Name (max 24)',
    createRoom: 'Create Room',

    howToPlay: 'Rules',
    open: 'Open',
    advanced: 'Advanced',
    done: 'Done',

    quickJoin: 'Quick Join',
    quickJoinBody: 'Paste a room code or full invite link. We will auto-detect it.',
    roomCodePlaceholder: 'Room code or invite URL',
    joinRoom: 'Join Room',
    lockedNote: 'If the room is locked, you will enter the key after joining.',

    activeRooms: 'Active Rooms',
    refresh: 'Refresh',
    searchRoomPlaceholder: 'Search room code or host',
    noPublicRooms: 'No public rooms yet. Create one!',
    noRoomsMatch: 'No rooms match your search.',
    full: 'Full',
    join: 'Join',
    playersOnline: '{current}/{max} players',

    leaderboardTitle: 'Global Leaderboard',
    leaderboardSubtitle: 'Top ROI, peak cash, and bragging rights.',
    share: 'Share',
    leaderboardShareHeadline: '{name} just hit {roi}% ROI in PK Candle.',
    leaderboardShareFallback: 'PK Candle global leaderboard is live.',
    leaderboardShareBody: '{headline} Come claim your spot.',
    leaderboardNameDefault: 'Gamerun',
    leaderboardNameLabel: 'Leaderboard name',
    leaderboardNamePlaceholder: 'Enter your public name',
    leaderboardNameHint: 'This name will be shown publicly. You can edit it before submitting.',
    leaderboardConfirmSubmit: 'Submit to the leaderboard as â€œ{name}â€?',
    localHistoryTitle: 'Your recent runs',
    localHistoryEmpty: 'No local runs yet.',
    localHistoryCash: 'Cash {cash} U',
    localHistoryRoi: 'ROI {roi}%',
    localHistoryRound: 'Round {round}',
    noScoresYet: 'No scores yet.',
    peak: 'Peak',
    pageNotFoundTitle: 'Page not found',
    pageNotFoundBody: 'Head back to the lobby.',
    goHome: 'Go Home',
    loginToAppear: 'Log in to appear on leaderboard',
    claimLeaderboard: 'Claim Leaderboard',

    gameOver: 'Game Over',
    youGotRekt: 'You got rekt.',
    sessionEnded: 'Session ended.',
    finalCash: 'Final Cash',
    shareToTwitter: 'Share to Twitter',
    topPlayers: 'Top Players',
    gameOverShare: 'Just survived PK Candle with ROI {roi}%! Join the chaos: {url}',
    cancel: 'Cancel',
    savePack: 'Save Pack',
    packCreateTitle: 'Create Event Pack',
    packEditTitle: 'Edit Event Pack',
    packEditorBody: 'Edit the JSON and save. This pack can be used as a map for your room.',
    packInvalidJson: 'Invalid JSON. Make sure the pack format is valid.',

    tradingDisabledJoin: 'Join the room to trade.',
    tradingDisabledNotActive: 'Trading disabled: player not ACTIVE.',
    tradingDisabledNotLive: 'Trading disabled: session is not LIVE.',
    respawnPaused: 'Respawning... {seconds}s',
    tradingDisabledPersonalEvent: 'Trading paused: personal event.',
    tradingDisabledPaused: 'Trading paused.',
    tradingDisabledInvalidPrice: 'Trading disabled: invalid market price.',
    authFailed: 'Failed to authenticate.',
    wsError: 'WebSocket error',
    leaderboardLoadFailed: 'Failed to load leaderboard.',
    leaderboardSubmitting: 'Submitting leaderboard...',
    leaderboardSubmitted: 'Leaderboard submitted.',
    leaderboardSubmitTimeout: 'Leaderboard submit timed out. Please try again.',
    leaderboardYourRank: 'Your rank: #{rank}',
    paginationPrev: 'Prev',
    paginationNext: 'Next',
    pageOf: 'Page {page} / {total}',
    leaderboardAlreadySubmitted: 'Already submitted.',
    leaderboardSubmitFailed: 'Failed to submit leaderboard.',
    leaderboardDbMissing: 'Leaderboard database not configured.',
    leaderboardDbUnavailable: 'Leaderboard database unavailable. Try again later.',
    leaderboardDbSchemaMissing: 'Leaderboard tables missing. Run db:push.',
    leaderboardServiceUnavailable: 'Leaderboard service unavailable. Try again later.',
    leaderboardPrivyMissing: 'Privy server keys are missing.',
    leaderboardWsDisconnected: 'Not connected to the game server.',
    chartLoadFailed: 'Chart failed to load',
    chartLoadFailedHint: 'Please refresh the page or try again.',
    reload: 'Reload',
  },
  'zh-CN': {
    appName: 'PK Candle',
    turboRoom: 'æé€Ÿæˆ¿',
    lobby: 'å¤§å…',
    leaderboard: 'æ’è¡Œæ¦œ',
    leaveRoom: 'ç¦»å¼€æˆ¿é—´',
    signedIn: 'å·²ç™»å½•',
    guest: 'æ¸¸å®¢',
    loading: 'åŠ è½½ä¸­',
    login: 'ç™»å½•',
    logout: 'ç™»å‡º',
    languageLabel: 'è¯­è¨€',
    languageToggle: 'åˆ‡æ¢è¯­è¨€',
    languageFlagsTitle: 'è¯­è¨€',
    languageChinese: 'ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰',
    languageEnglish: 'è‹±æ–‡',
    joiningRoom: 'æ­£åœ¨æ£€æŸ¥æˆ¿é—´æƒé™...',

    missingWsTitle: 'ç¼ºå°‘ WebSocket åœ°å€',
    missingWsBody: 'è¯·è®¾ç½® VITE_WS_URL ä»¥è¿æ¥æœåŠ¡å™¨ã€‚',

    roomNotFoundTitle: 'æˆ¿é—´ä¸å­˜åœ¨',
    roomNotFoundBody: 'è¯·ä»å¤§å…é€‰æ‹©æˆ¿é—´ã€‚',
    alreadyInRoomTitle: 'ä½ å·²åœ¨æˆ¿é—´ {roomId}',
    alreadyInRoomBody: 'åŠ å…¥å…¶ä»–æˆ¿é—´å‰è¯·å…ˆç¦»å¼€å½“å‰æˆ¿é—´ã€‚',
    goToRoom: 'è¿›å…¥æˆ¿é—´',
    backToLobby: 'è¿”å›å¤§å…',
    joinRoomTitle: 'åŠ å…¥æˆ¿é—´ {roomId}',
    enterRoomKey: 'è‹¥æˆ¿é—´ä¸Šé”ï¼Œè¯·è¾“å…¥æˆ¿é—´é’¥åŒ™ã€‚',
    nameLabel: 'åå­—',
    roomKeyLabel: 'æˆ¿é—´é’¥åŒ™',
    roomKeyPlaceholder: 'æˆ¿é—´é’¥åŒ™',
    roomLockLabel: 'æˆ¿é—´ä¸Šé”',
    roomLockOn: 'å·²ä¸Šé”',
    roomLockOff: 'æœªä¸Šé”',
    roomLockHint: 'å¼€å¯åéœ€è¦é’¥åŒ™æ‰èƒ½è¿›å…¥ã€‚',
    roomNameLabel: 'æˆ¿é—´åç§°ï¼ˆæœ€å¤š 24 å­—ï¼Œæ”¯æŒè¡¨æƒ…ï¼‰',
    roomNamePlaceholder: 'Kevin çš„æ™šé¤æ¡Œ ğŸ¤“',
    maxPlayersLabel: 'äººæ•°ä¸Šé™ï¼ˆ2-6ï¼‰',
    playersCount: '{count} äºº',
    enterRoom: 'è¿›å…¥æˆ¿é—´',
    connecting: 'è¿æ¥ä¸­â€¦',

    sessionTitle: 'å›åˆ',
    statusLabel: 'çŠ¶æ€',
    roundLabel: 'å›åˆ {round}/{total}',
    timeLeftLabel: 'å‰©ä½™æ—¶é—´ {time}',
    startingIn: 'å³å°†å¼€å§‹ {seconds}s',
    getReady: 'å‡†å¤‡å¼€å§‹',
    paused: 'æš‚åœä¸­',
    eventPausedTitle: 'å…¨å±€äº‹ä»¶æš‚åœ',
    eventPausedBody: 'å¸‚åœºäº‹ä»¶ç»“ç®—ä¸­ï¼Œå€’è®¡æ—¶ç»“æŸåç»§ç»­äº¤æ˜“ã€‚',
    eventImpactTitle: 'å½±å“è¯´æ˜',
    eventImpactPhase: 'é˜¶æ®µï¼š{phase}',
    eventImpactVolatility: 'æ³¢åŠ¨ï¼š{value}',
    eventImpactPrice: 'ä»·æ ¼å€æ•°ï¼šx{value}',
    eventImpactNeutral: 'æš‚æ— ç›´æ¥å¸‚åœºå½±å“ã€‚',
    nextRoundIn: 'ä¸‹ä¸€å›åˆ {seconds}s',
    personalEventCountdown: 'å€’è®¡æ—¶ {seconds}s',
    personalEventExpired: 'äº‹ä»¶å·²è¶…æ—¶ï¼Œæ­£åœ¨ç»“ç®—...',
    respawnWarning: 'ç³»ç»Ÿæç¤º',
    respawnTitleBroke: 'çˆ†ä»“äº†',
    respawnTitleDead: 'å€’ä¸‹äº†',
    respawnPenalty: 'æƒ©ç½šï¼šèµ„é‡‘é‡ç½®ä¸ºåŸºç¡€èµ„é‡‘çš„ {percent}%ã€‚',
    respawnCurrentCash: 'å½“å‰èµ„é‡‘ï¼š{cash} U',
    respawnNewCash: 'é‡æ–°å‘æ”¾ï¼š{cash} U',
    respawnCountdown: 'é‡æ–°è¿›å…¥å€’è®¡æ—¶ {seconds}s',

    you: 'ä½ ',
    cash: 'ç°é‡‘',
    equity: 'æƒç›Š',
    pnl: 'ç›ˆäº',
    stress: 'å‹åŠ›',
    connection: 'è¿æ¥',
    connectionIdle: 'ç©ºé—²',
    connectionConnecting: 'è¿æ¥ä¸­',
    connectionConnected: 'å·²è¿æ¥',
    connectionError: 'é”™è¯¯',

    globalEvents: 'å…¨å±€äº‹ä»¶',
    noMarketShocks: 'æš‚æ— å¸‚åœºå†²å‡»ã€‚',

    marketTitle: 'å¸‚åœº',
    loadingToken: 'è½½å…¥å¸ç§â€¦',
    phaseLabel: 'é˜¶æ®µï¼š{phase}',
    goLive: 'å›åˆ°æœ€æ–°',
    fitView: 'é€‚é…è§†å›¾',
    localTime: 'æœ¬åœ°æ—¶é—´ï¼š{time}',
    lastCandle: 'æœ€æ–° K çº¿ï¼š{time}',
    scrollToZoom: 'æ»šè½®ç¼©æ”¾',
    timeframe1s: '1 ç§’',
    timeframe5s: '5 ç§’',
    timeframe10s: '10 ç§’',

    tradeTitle: 'äº¤æ˜“',
    tradingDisabledTitle: 'äº¤æ˜“ä¸å¯ç”¨',
    tradingDisabledGeneric: 'å½“å‰æ— æ³•äº¤æ˜“ã€‚',
    orderSize: 'ä¸‹å•æ¯”ä¾‹',
    percent: 'æ¯”ä¾‹',
    amount: 'é‡‘é¢',
    available: 'å¯ç”¨',
    orderValue: 'ä¸‹å•é‡‘é¢',
    size: 'æ•°é‡',
    positionMargin: 'æŒä»“ä¿è¯é‡‘',
    addOrderValue: 'åŠ ä»“é‡‘é¢',
    reduceOrderValue: 'å‡ä»“é‡‘é¢',
    tpPlaceholder: 'æ­¢ç›ˆ %',
    slPlaceholder: 'æ­¢æŸ %',
    tpSlTitle: 'æ­¢ç›ˆæ­¢æŸï¼ˆå¯é€‰ï¼‰',
    tpSlHint: 'è§¦å‘ç›®æ ‡ä»·åè‡ªåŠ¨å¹³ä»“ã€‚',
    leverage: 'æ æ†',
    long: 'åšå¤š',
    short: 'åšç©º',
    openLong: 'å¼€å¤š',
    openShort: 'å¼€ç©º',
    addLong: 'åŠ å¤š',
    addShort: 'åŠ ç©º',
    reduceLong: 'å‡å¤š',
    reduceShort: 'å‡ç©º',
    closePosition: 'å¹³ä»“',
    positionTitle: 'æŒä»“',
    noOpenPosition: 'æš‚æ— æŒä»“ã€‚',
    side: 'æ–¹å‘',
    entry: 'å¼€ä»“ä»·',
    price: 'ä»·æ ¼',
    liquidation: 'å¼ºå¹³ä»·',
    entryLine: 'å¼€ä»“',
    avgCostLine: 'å¹³å‡æˆæœ¬',
    markPriceLine: 'ç°ä»·',
    liquidationLine: 'å¼ºå¹³',
    margin: 'ä¿è¯é‡‘',
    tradeHistory: 'äº¤æ˜“è®°å½•',
    tradeOpen: 'å¼€ä»“',
    tradeClose: 'å¹³ä»“',
    tradeLiquidation: 'çˆ†ä»“',
    noTradesYet: 'æš‚æ— äº¤æ˜“è®°å½•ã€‚',

    chat: 'èŠå¤©',
    chatRoom: 'èŠå¤©å®¤',
    chatPlaceholder: 'è¾“å…¥æ¶ˆæ¯',
    chatJoinPlaceholder: 'åŠ å…¥æˆ¿é—´åæ‰èƒ½èŠå¤©',
    send: 'å‘é€',
    danmakuOn: 'å¼€',
    danmakuOff: 'å…³',
    danmakuLabel: 'å¼¹å¹•',
    close: 'å…³é—­',
    spectatorTag: 'è§‚æˆ˜',

    roomRank: 'æˆ¿å†…æ’è¡Œ',
    topN: 'å‰ {count}',
    noPlayersYet: 'æš‚æ— ç©å®¶ã€‚',
    roomPnl: 'æˆ¿å†…ç›ˆäº',
    packLabel: 'äº‹ä»¶åŒ…',
    corePack: 'æ ¸å¿ƒåŒ…',
    hostLabel: 'æˆ¿ä¸»',
    packHelp: 'äº‹ä»¶åŒ… = æˆ¿é—´è§„åˆ™ä¸äº‹ä»¶ã€‚',
    packTitle: 'äº‹ä»¶åŒ…',
    packSelectLabel: 'é€‰æ‹©äº‹ä»¶åŒ…',
    packVersion: 'v{version}',
    packNoDescription: 'æš‚æ— è¯´æ˜ã€‚',
    packPersonalCount: 'ä¸ªäººäº‹ä»¶ {count}',
    packMarketCount: 'å…¨å±€äº‹ä»¶ {count}',
    createPack: 'æ–°å»ºäº‹ä»¶åŒ…',
    editPack: 'ç¼–è¾‘äº‹ä»¶åŒ…',
    deletePack: 'åˆ é™¤äº‹ä»¶åŒ…',
    packLockedNote: 'å€’è®¡æ—¶å¼€å§‹åæ— æ³•åˆ‡æ¢äº‹ä»¶åŒ…ã€‚',

    lobbyTitle: 'å¤§å…',
    roomLabel: 'æˆ¿é—´ï¼š{roomId}',
    inviteCrew: 'é‚€è¯·é˜Ÿå‹',
    inviteCopied: 'å·²å¤åˆ¶é‚€è¯·',
    inviteFailed: 'å¤åˆ¶å¤±è´¥',
    inviteTitle: 'PK Candle è½¦é˜Ÿå‡ºå‘ã€‚',
    inviteRoomCode: 'æˆ¿é—´ç ï¼š{roomId}',
    inviteBringTrades: 'å¸¦ä¸Šä½ çš„æœ€ä½³äº¤æ˜“ã€‚',
    inviteJoin: 'åŠ å…¥ï¼š{url}',
    inviteLockedNote: 'æˆ¿é—´å·²ä¸Šé”ï¼Œè¯·å‘æˆ¿ä¸»ç´¢å–é’¥åŒ™ã€‚',
    inviteUnlockedNote: 'æ— éœ€é’¥åŒ™å³å¯è¿›å…¥ã€‚',
    inviteCopyPrompt: 'å¤åˆ¶é‚€è¯·å†…å®¹',
    readyCount: 'å‡†å¤‡ {ready}/{total}',
    cancelReady: 'å–æ¶ˆå‡†å¤‡',
    readyUp: 'å‡†å¤‡å¥½äº†',
    startCountdown: 'å¼€å§‹å€’è®¡æ—¶',
    waitingHost: 'ç­‰å¾…æˆ¿ä¸»',
    readyUpToStart: 'æ‰€æœ‰äººå‡†å¤‡åå¼€å§‹',
    roomLockTitle: 'æˆ¿é—´é”',
    locked: 'å·²ä¸Šé”',
    unlocked: 'æœªä¸Šé”',
    hostControlsKey: 'åªæœ‰æˆ¿ä¸»èƒ½ä¿®æ”¹é’¥åŒ™ã€‚',
    setUpdateKey: 'è®¾ç½® / æ›´æ–°é’¥åŒ™',
    setRoomKeyPlaceholder: 'è®¾ç½®æˆ¿é—´é’¥åŒ™',
    setNewRoomKeyPlaceholder: 'è®¾ç½®æ–°çš„æˆ¿é—´é’¥åŒ™',
    updateKey: 'æ›´æ–°é’¥åŒ™',
    removeLock: 'ç§»é™¤é”',
    lockHelp: 'ç©å®¶è¿›å…¥æˆ¿é—´åå†è¾“å…¥é’¥åŒ™ã€‚',
    lockDisabled: 'å€’è®¡æ—¶å¼€å§‹åæ— æ³•æ›´æ”¹ã€‚',
    seatsTitle: 'åº§ä½ï¼ˆæœ€å¤š {max}ï¼‰',
    seatLabel: 'åº§ä½ {number}',
    ready: 'å·²å‡†å¤‡',
    notReady: 'æœªå‡†å¤‡',
    online: 'åœ¨çº¿',
    offline: 'ç¦»çº¿',
    kick: 'è¸¢å‡º',
    emptySeat: 'ç©ºä½',
    spectatorsTitle: 'è§‚ä¼—',
    spectatorDisabled: 'æš‚ä¸å¼€æ”¾è§‚æˆ˜æ¨¡å¼ã€‚',
    hostTag: 'æˆ¿ä¸»',

    startTitle: 'PK Candle',
    startTagline: 'è¿·å› å¸‚åœºå¯¹æˆ˜ã€‚åŒä¸€æ ¹ K çº¿ä¸€èµ·å†²ï¼Œæ´»åˆ°æœ€åï¼Œç§€å‡ºæ”¶ç›Šã€‚',
    startBadgeLive: 'å®æ—¶æˆ¿é—´',
    startBadgeLobbies: '6 äººå¤§å…',
    startBadgeLeaderboard: 'å…¨çƒæ’è¡Œæ¦œ',

    createRoomTitle: 'åˆ›å»ºæˆ¿é—´',
    createRoomBody: 'åˆ›å»ºæˆ¿é—´åï¼Œå¯åœ¨æˆ¿å†…å¤åˆ¶é‚€è¯·é“¾æ¥ã€‚',
    playerNameLabel: 'ç©å®¶åç§°',
    playerNamePlaceholder: 'æé€Ÿäº¤æ˜“å‘˜',
    roomCodeLabel: 'æˆ¿é—´ä»£ç ',
    roomCodeAutoPlaceholder: 'è‡ªåŠ¨ç”Ÿæˆ',
    newCode: 'æ–°ä»£ç ',
    roomNameLabelShort: 'æˆ¿é—´åç§°ï¼ˆæœ€å¤š 24 å­—ï¼‰',
    createRoom: 'åˆ›å»ºæˆ¿é—´',

    howToPlay: 'è§„åˆ™è¯´æ˜',
    open: 'æ‰“å¼€',
    advanced: 'é«˜çº§',
    done: 'å®Œæˆ',

    quickJoin: 'å¿«é€ŸåŠ å…¥',
    quickJoinBody: 'ç²˜è´´æˆ¿é—´ä»£ç æˆ–å®Œæ•´é‚€è¯·é“¾æ¥ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨è¯†åˆ«ã€‚',
    roomCodePlaceholder: 'æˆ¿é—´ä»£ç æˆ–é‚€è¯·é“¾æ¥',
    joinRoom: 'åŠ å…¥æˆ¿é—´',
    lockedNote: 'å¦‚æœæˆ¿é—´ä¸Šé”ï¼ŒåŠ å…¥åä¼šæç¤ºè¾“å…¥é’¥åŒ™ã€‚',

    activeRooms: 'æ´»è·ƒæˆ¿é—´',
    refresh: 'åˆ·æ–°',
    searchRoomPlaceholder: 'æœç´¢æˆ¿é—´ç æˆ–æˆ¿ä¸»',
    noPublicRooms: 'è¿˜æ²¡æœ‰å…¬å¼€æˆ¿é—´ï¼Œå¿«åˆ›å»ºä¸€ä¸ªï¼',
    noRoomsMatch: 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æˆ¿é—´ã€‚',
    full: 'å·²æ»¡',
    join: 'åŠ å…¥',
    playersOnline: '{current}/{max} äºº',

    leaderboardTitle: 'å…¨çƒæ’è¡Œæ¦œ',
    leaderboardSubtitle: 'æœ€é«˜ ROIã€å³°å€¼èµ„é‡‘å’Œç‚«è€€æƒã€‚',
    share: 'åˆ†äº«',
    leaderboardShareHeadline: '{name} åœ¨ PK Candle è¾¾æˆ {roi}% ROIï¼',
    leaderboardShareFallback: 'PK Candle å…¨çƒæ’è¡Œæ¦œå·²å¼€å¯ã€‚',
    leaderboardShareBody: '{headline} å¿«æ¥å ä½ï¼',
    leaderboardNameDefault: 'Gamerun',
    leaderboardNameLabel: 'æ’è¡Œæ¦œæ˜µç§°',
    leaderboardNamePlaceholder: 'å¡«å†™å±•ç¤ºæ˜µç§°',
    leaderboardNameHint: 'æ˜µç§°ä¼šå…¬å¼€å±•ç¤ºï¼Œä½ å¯ä»¥åœ¨æäº¤å‰ä¿®æ”¹ã€‚',
    leaderboardConfirmSubmit: 'ç¡®å®šä»¥ã€Œ{name}ã€æäº¤æ’è¡Œæ¦œï¼Ÿ',
    localHistoryTitle: 'æœ¬åœ°æˆ˜ç»©',
    localHistoryEmpty: 'æš‚æ— æœ¬åœ°æˆ˜ç»©ã€‚',
    localHistoryCash: 'ç°é‡‘ {cash} U',
    localHistoryRoi: 'ROI {roi}%',
    localHistoryRound: 'ç¬¬ {round} å›åˆ',
    noScoresYet: 'æš‚æ— æˆç»©ã€‚',
    peak: 'å³°å€¼',
    pageNotFoundTitle: 'é¡µé¢ä¸å­˜åœ¨',
    pageNotFoundBody: 'è¿”å›å¤§å…ç»§ç»­æ“ä½œã€‚',
    goHome: 'è¿”å›é¦–é¡µ',
    loginToAppear: 'ç™»å½•åæ‰ä¼šå‡ºç°åœ¨æ’è¡Œæ¦œ',
    claimLeaderboard: 'é¢†å–æ’è¡Œæ¦œ',

    gameOver: 'æ¸¸æˆç»“æŸ',
    youGotRekt: 'ä½ è¢«æ¸…ç®—äº†ã€‚',
    sessionEnded: 'æœ¬å›åˆç»“æŸã€‚',
    finalCash: 'æœ€ç»ˆç°é‡‘',
    shareToTwitter: 'åˆ†äº«è‡³æ¨ç‰¹',
    topPlayers: 'é«˜æ‰‹æ¦œ',
    gameOverShare: 'åˆšåœ¨ PK Candle æ´»åˆ°æœ€åï¼ŒROI {roi}%ï¼åŠ å…¥æˆ˜å±€ï¼š{url}',
    cancel: 'å–æ¶ˆ',
    savePack: 'ä¿å­˜åŒ…',
    packCreateTitle: 'åˆ›å»ºäº‹ä»¶åŒ…',
    packEditTitle: 'ç¼–è¾‘äº‹ä»¶åŒ…',
    packEditorBody: 'ç¼–è¾‘ JSON å¹¶ä¿å­˜ã€‚è¯¥åŒ…å¯ä½œä¸ºæˆ¿é—´åœ°å›¾ä½¿ç”¨ã€‚',
    packInvalidJson: 'JSON æ— æ•ˆï¼Œè¯·ç¡®è®¤æ ¼å¼æ­£ç¡®ã€‚',

    tradingDisabledJoin: 'åŠ å…¥æˆ¿é—´åæ‰èƒ½äº¤æ˜“ã€‚',
    tradingDisabledNotActive: 'äº¤æ˜“ä¸å¯ç”¨ï¼šç©å®¶çŠ¶æ€é ACTIVEã€‚',
    tradingDisabledNotLive: 'äº¤æ˜“ä¸å¯ç”¨ï¼šå›åˆæœªå¼€å§‹ã€‚',
    respawnPaused: 'çˆ†ä»“ä¿æŠ¤ä¸­... {seconds}s',
    tradingDisabledPersonalEvent: 'ä¸ªäººäº‹ä»¶å¤„ç†ä¸­ï¼Œæš‚åœäº¤æ˜“ã€‚',
    tradingDisabledPaused: 'äº¤æ˜“å·²æš‚åœã€‚',
    tradingDisabledInvalidPrice: 'äº¤æ˜“ä¸å¯ç”¨ï¼šä»·æ ¼æ— æ•ˆã€‚',
    authFailed: 'è®¤è¯å¤±è´¥ã€‚',
    wsError: 'WebSocket é”™è¯¯',
    leaderboardLoadFailed: 'åŠ è½½æ’è¡Œæ¦œå¤±è´¥ã€‚',
    leaderboardSubmitting: 'æ­£åœ¨æäº¤æ’è¡Œæ¦œ...',
    leaderboardSubmitted: 'æ’è¡Œæ¦œæäº¤æˆåŠŸã€‚',
    leaderboardSubmitTimeout: 'æäº¤è¶…æ—¶ï¼Œè¯·é‡è¯•ã€‚',
    leaderboardYourRank: 'ä½ çš„æ’åï¼š#{rank}',
    paginationPrev: 'ä¸Šä¸€é¡µ',
    paginationNext: 'ä¸‹ä¸€é¡µ',
    pageOf: 'ç¬¬ {page}/{total} é¡µ',
    leaderboardAlreadySubmitted: 'å·²æäº¤è¿‡ã€‚',
    leaderboardSubmitFailed: 'æäº¤æ’è¡Œæ¦œå¤±è´¥ã€‚',
    leaderboardDbMissing: 'æ’è¡Œæ¦œæ•°æ®åº“å°šæœªé…ç½®ã€‚',
    leaderboardDbUnavailable: 'æ’è¡Œæ¦œæ•°æ®åº“ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚',
    leaderboardDbSchemaMissing: 'æ’è¡Œæ¦œè¡¨ä¸å­˜åœ¨ï¼Œè¯·å…ˆæ‰§è¡Œ db:pushã€‚',
    leaderboardServiceUnavailable: 'æ’è¡Œæ¦œæœåŠ¡ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚',
    leaderboardPrivyMissing: 'æœåŠ¡å™¨æœªé…ç½® Privyã€‚',
    leaderboardWsDisconnected: 'æœªè¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨ã€‚',
    chartLoadFailed: 'å›¾è¡¨åŠ è½½å¤±è´¥',
    chartLoadFailedHint: 'è¯·åˆ·æ–°é¡µé¢æˆ–ç¨åå†è¯•ã€‚',
    reload: 'åˆ·æ–°',
  },
};

const STATUS_LABELS: Record<Language, Record<SessionStatus, string>> = {
  en: {
    LOBBY: 'Lobby',
    COUNTDOWN: 'Countdown',
    LIVE: 'Live',
    ENDED: 'Ended',
  },
  'zh-CN': {
    LOBBY: 'å¤§å…',
    COUNTDOWN: 'å€’è®¡æ—¶',
    LIVE: 'è¿›è¡Œä¸­',
    ENDED: 'å·²ç»“æŸ',
  },
};

const PLAYER_STATUS_LABELS: Record<Language, Record<PlayerSummary['status'], string>> = {
  en: {
    ACTIVE: 'LIVE',
    ELIMINATED: 'OUT',
    FINISHED: 'DONE',
  },
  'zh-CN': {
    ACTIVE: 'è¿›è¡Œä¸­',
    ELIMINATED: 'æ·˜æ±°',
    FINISHED: 'ç»“æŸ',
  },
};

const I18nContext = createContext<{
  lang: Language;
  setLang: (next: Language) => void;
  t: (key: keyof typeof MESSAGES.en, vars?: Record<string, string | number>) => string;
} | null>(null);

const interpolate = (template: string, vars?: Record<string, string | number>) => {
  if (!vars) return template;
  return template.replace(/\{(\w+)\}/g, (_, key) => {
    const value = vars[key];
    return value === undefined ? '' : String(value);
  });
};

export const I18nProvider = ({ children }: { children: React.ReactNode }) => {
  const [lang, setLangState] = useState<Language>(() => {
    if (typeof window === 'undefined') return 'zh-CN';
    const stored = window.localStorage.getItem(STORAGE_KEY) as Language | null;
    return stored === 'en' || stored === 'zh-CN' ? stored : 'zh-CN';
  });

  useEffect(() => {
    if (typeof window === 'undefined') return;
    window.localStorage.setItem(STORAGE_KEY, lang);
  }, [lang]);

  const setLang = useCallback((next: Language) => {
    setLangState(next);
  }, []);

  const t = useCallback((key: keyof typeof MESSAGES.en, vars?: Record<string, string | number>) => {
    const bundle = MESSAGES[lang] ?? MESSAGES.en;
    const template = bundle[key] ?? MESSAGES.en[key] ?? key;
    return interpolate(String(template), vars);
  }, [lang]);

  const value = useMemo(() => ({ lang, setLang, t }), [lang, setLang, t]);

  return (
    <I18nContext.Provider value={value}>
      {children}
    </I18nContext.Provider>
  );
};

export const useI18n = () => {
  const context = useContext(I18nContext);
  if (!context) throw new Error('useI18n must be used within I18nProvider');
  return context;
};

export const formatSessionStatus = (status: SessionStatus, lang: Language) => {
  return STATUS_LABELS[lang][status] ?? status;
};

export const formatPlayerStatus = (status: PlayerSummary['status'], lang: Language) => {
  return PLAYER_STATUS_LABELS[lang][status] ?? status;
};

export const getHowToPlaySections = (lang: Language) => {
  if (lang === 'zh-CN') {
    return [
      {
        title: 'ç›®æ ‡',
        body: 'åœ¨ 3 åˆ†é’Ÿå›åˆå†…ç”Ÿå­˜ï¼Œæ‹¿åˆ°æœ€é«˜ ROIï¼Œå¹¶ç™»ä¸Šå…¨çƒæ’è¡Œæ¦œã€‚',
      },
      {
        title: 'èµ„é‡‘ä¸ä»“ä½',
        body: 'ä½¿ç”¨æ»‘æ†æŠ•å…¥ 5â€“100% èµ„é‡‘ï¼ˆé»˜è®¤ 1x æ æ†ï¼‰ã€‚å¹³ä»“å³å¯é”å®šç›ˆäºï¼›ä»·æ ¼è§¦åŠå¼ºå¹³çº¿ä¼šè¢«æ¸…ç®—ã€‚',
      },
      {
        title: 'å…¨å±€äº‹ä»¶',
        body: 'å¸‚åœºå†²å‡»ä¼šå½±å“æ‰€æœ‰äººï¼Œå¹¶çŸ­æš‚æš‚åœäº¤æ˜“ã€‚æ‰€æœ‰äººçœ‹åˆ°åŒä¸€æ ¹ K çº¿ã€‚',
      },
      {
        title: 'ä¸ªäººäº‹ä»¶',
        body: 'åªå¯¹ä½ å¯è§ï¼Œé€‰æ‹©é€‰é¡¹ä¼šæ”¹å˜ç°é‡‘ï¼ˆä¸å‹åŠ›æç¤ºï¼‰ã€‚',
      },
      {
        title: 'æˆ¿é—´æµç¨‹',
        body: 'æ‰€æœ‰äººå‡†å¤‡åç”±æˆ¿ä¸»å¼€å§‹ 5 ç§’å€’è®¡æ—¶ã€‚ä»»ä¸€äººå–æ¶ˆå‡†å¤‡åˆ™å€’è®¡æ—¶åœæ­¢ã€‚',
      },
      {
        title: 'å›åˆ',
        body: '3 åˆ†é’Ÿå›åˆåˆ†ä¸º 6 è½®ï¼ˆè¿›åº¦æ¡æ˜¾ç¤ºï¼‰ã€‚çˆ†ä»“åä¼šé‡ç”Ÿå¹¶é‡ç½®èµ„é‡‘ã€‚',
      },
    ];
  }

  return [
    {
      title: 'Goal',
      body: 'Survive the 3-minute session, stack the highest ROI, and claim the global leaderboard.',
    },
    {
      title: 'Cash & Positions',
      body: 'Use the size slider to commit 5â€“100% of your cash per trade (1x leverage). Close to lock PnL. Liquidation hits when price crosses your liq line.',
    },
      {
        title: 'Global Events',
        body: 'Market shocks broadcast to everyone and pause trading for a few seconds. Everyone sees the same candle move.',
      },
      {
        title: 'Personal Events',
        body: 'Only you see your personal event. Pick a choice to adjust cash (plus stress flavor).',
      },
      {
        title: 'Room Flow',
      body: 'Everyone readies up. Host starts a 5-second countdown. If anyone cancels ready, the countdown stops.',
    },
    {
      title: 'Rounds',
      body: 'The 3-minute session is split into 6 rounds (progress bar). If you blow up, you respawn with fresh funds instead of being kicked.',
    },
  ];
};
